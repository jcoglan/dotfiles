#!/bin/bash

CDB_AUTH='admin:admin'
CDB_HOST='127.0.0.1'
CDB_PORT=5984

cdb () {
  curl -gs -H 'Content-Type: application/json' "$(cdb-host)$1" "${@:2}"
}

cdb-host () {
  echo "http://${CDB_AUTH}@${CDB_HOST}:${CDB_PORT}"
}

cdb-nodes () {
  cdb '/_membership' | jq -r '.cluster_nodes[]'
}

cdb-config-get () {
  local key="$1"

  cdb-nodes | while read -r node ; do
    echo "[$node]"
    cdb "/_node/$node/_config/$key"
  done
}

cdb-config-set () {
  local key="$1"
  local value="$2"

  cdb-nodes | while read -r node ; do
    echo "[$node] $key = $value"
    cdb "/_node/$node/_config/$key" -X PUT -d "$value"
  done
}

cdb-enable-cors () {
  cdb-config-set 'httpd/enable_cors' '"true"'
  cdb-config-set 'cors/origins' '"*"'
  cdb-config-set 'cors/credentials' '"true"'
  cdb-config-set 'cors/methods' '"GET, PUT, POST, HEAD, DELETE"'
  cdb-config-set 'cors/headers' '"accept, authorization, content-type, origin, referer, x-csrf-token"'
}

cdb-edit () {
  local doc="$1"
  local file="/tmp/couch-doc-$RANDOM.json"

  cdb "$doc" | jq > "$file"

  if "${EDITOR:-vim}" "$file" ; then
    cdb "$doc" -iX PUT -d @"$file"
  fi
  rm "$file"
}
